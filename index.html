<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰“ç‰Œè®°è´¦ LeanCloud ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-realtime@5.0.0-rc.7/dist/realtime-browser.min.js"></script>
    <style>
        :root { --green: #07c160; --red: #ee0a24; --gray: #969799; }
        body { font-family: -apple-system, sans-serif; background: #f7f8fa; margin: 0; padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        h3 { margin-top: 0; font-size: 16px; color: #323233; }
        
        /* ç©å®¶åˆ—è¡¨ */
        .player-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .player-item { text-align: center; padding: 10px 5px; border: 1px solid #ebedf0; border-radius: 8px; }
        .player-item.is-me { border-color: var(--green); background: #f0fff5; }
        .avatar { font-size: 24px; }
        .nickname { font-size: 12px; color: #646566; margin: 4px 0; }
        .score { font-weight: bold; font-size: 16px; }
        
        /* æµæ°´ */
        .log-item { display: flex; justify-content: space-between; font-size: 13px; padding: 8px 0; border-bottom: 1px solid #fafafa; }
        .log-amount { font-weight: bold; }
        .plus { color: var(--green); }
        .minus { color: var(--red); }
        .time { color: var(--gray); font-size: 11px; }
    </style>
</head>
<body>

<div class="card">
    <h3>æˆ¿é—´çŠ¶æ€: <span id="status">è¿æ¥ä¸­...</span></h3>
    <div class="player-list" id="playerContainer"></div>
</div>

<div class="card">
    <h3>è´¦ç›®æµæ°´ (ç‚¹å‡»å¤´åƒè®°è´¦)</h3>
    <div id="logContainer"></div>
</div>

<script>
    // --- 1. é…ç½®ä¿¡æ¯ (å¡«å…¥ä½ çš„ LeanCloud å‡­è¯) ---
    const CONFIG = {
        appId: 'AdlxgSsdrDHWPHP3fYr8jKlC-MdYXbMMI',
        appKey: 'DTYB3105pTXtUfJcFEuSNaPC',
        serverURL: 'https://adlxgssd.api.lncldglobal.com' 
    };

    // --- 2. åˆå§‹åŒ–å˜é‡ ---
    const { Realtime, TextMessage } = AV;
    let client, conversation;
    let scores = {}; // å†…å­˜ä¸­è®¡ç®—åˆ†æ•°
    let myNickname = 'ç©å®¶_' + Math.floor(Math.random() * 1000); // éšæœºåˆ†é…æ˜µç§°

    // --- 3. æ ¸å¿ƒé€»è¾‘ ---

    async function init() {
        const realtime = new Realtime({
            appId: CONFIG.appId,
            appKey: CONFIG.appKey,
            serverURLs: CONFIG.serverURL
        });

        try {
            // ç™»å½•
            client = await realtime.createIMClient(myNickname);
            document.getElementById('status').innerText = 'å·²åœ¨çº¿ (' + myNickname + ')';

            // åŠ å…¥/åˆ›å»ºå›ºå®šæˆ¿é—´ (MVPé˜¶æ®µä½¿ç”¨å›ºå®šIDæµ‹è¯•)
            conversation = await client.createConversation({
                name: 'æ‰“ç‰Œè®°è´¦æˆ¿é—´',
                unique: true, // ç¡®ä¿åŒä¸€ä¸ªåå­—åªåˆ›å»ºä¸€ä¸ªå¯¹è¯
            });

            // è·å–å†å²è®°å½•å¹¶è®¡ç®—åˆå§‹åˆ†æ•°
            const iter = conversation.createMessagesIterator({ limit: 50 });
            const { value: messages } = await iter.next();
            messages.forEach(processMsg);
            
            // ç›‘å¬æ–°è´¦å•
            client.on('message', (message) => {
                processMsg(message);
            });

            renderUI();
        } catch (err) {
            console.error(err);
            alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œ');
        }
    }

    // å¤„ç†æ¯ä¸€ç¬”è´¦å•æ¶ˆæ¯
    function processMsg(msg) {
        const attr = msg.attributes;
        if (attr && attr.type === 'BILL') {
            const { from, to, amount } = attr;
            scores[from] = (scores[from] || 0) - amount;
            scores[to] = (scores[to] || 0) + amount;
            
            // æ·»åŠ åˆ°æµæ°´æ˜¾ç¤º
            const logHTML = `
                <div class="log-item">
                    <span>${from} è¾“ç»™ ${to}</span>
                    <span class="log-amount minus">-${amount}</span>
                </div>
            `;
            document.getElementById('logContainer').insertAdjacentHTML('afterbegin', logHTML);
        }
        renderUI();
    }

    // è®°è´¦ï¼šå‘é€è‡ªå®šä¹‰å±æ€§æ¶ˆæ¯
    async function sendBill(toNickname) {
        if (toNickname === myNickname) return alert('ä¸èƒ½ç»™è‡ªå·±è½¬è´¦ï¼');
        const amount = prompt(`è¾“ç»™ ${toNickname} å¤šå°‘åˆ†ï¼Ÿ`);
        if (!amount || isNaN(amount)) return;

        const message = new TextMessage(`[è®°è´¦] ${myNickname} -> ${toNickname} : ${amount}`);
        message.setAttributes({
            type: 'BILL',
            from: myNickname,
            to: toNickname,
            amount: parseInt(amount)
        });

        await conversation.send(message);
        // å‘é€æˆåŠŸåï¼Œæœ¬åœ°ä¼šè‡ªåŠ¨é€šè¿‡ç›‘å¬ message äº‹ä»¶æ¥æ›´æ–°UI
    }

    // æ¸²æŸ“ç•Œé¢
    function renderUI() {
        const container = document.getElementById('playerContainer');
        // ç®€å•ç¡®ä¿æ‰€æœ‰å‡ºç°åœ¨è´¦å•é‡Œçš„äººéƒ½åœ¨åˆ—è¡¨ä¸­
        const allPlayers = new Set([myNickname, ...Object.keys(scores)]);
        
        container.innerHTML = Array.from(allPlayers).map(name => `
            <div class="player-item ${name === myNickname ? 'is-me' : ''}" onclick="sendBill('${name}')">
                <div class="avatar">ğŸ‘¤</div>
                <div class="nickname">${name}</div>
                <div class="score">${scores[name] || 0}</div>
            </div>
        `).join('');
    }

    init();
</script>
</body>
</html>